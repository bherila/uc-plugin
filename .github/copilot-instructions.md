# Copilot instructions for uc-plugin

## Architecture & data flow
- Next.js App Router under src/app with server components and API routes; server-only helpers live in src/server_lib.
- Shopify integrations go through src/server_lib/shopify.ts (shopify-api-node, GraphQL API 2025-10). Most mutations/queries are inline `#graphql` strings (see src/server_lib/shopifyCancelOrder.ts, shopifyGetOrdersWithLineItems.ts).
- Order webhook flow: src/app/api/shopify/webhook/route.ts parses webhook payloads → calls src/server_lib/shopifyProcessOrder.ts, which locks orders via Prisma `order_lock`, writes audit logs to `v3_audit_log`, allocates manifests in MySQL, and edits Shopify orders.
- Two DB layers are used:
  - Prisma client in src/server_lib/prisma.ts for models + audit logs.
  - serverless-mysql wrapper in src/server_lib/db.ts for raw SQL on v3_* tables. Always `await db.end()` in API routes (see webhook/route.ts).
- Session auth: src/server_lib/session.ts uses encrypted cookies (JWE) and is enforced in API routes/pages via `getSession()`.
- Typed SQL queries are generated by Prisma (`generator typedSql`) and used via `@prisma/client/sql` + `prisma.$queryRawTyped` (see src/app/data/purchasers_by_varietal/page.tsx).

## Project-specific conventions
- Shopify IDs are always `gid://shopify/...` strings and are validated before mutations (e.g., src/server_lib/shopifySetLineItemQuantity.ts).
- GraphQL responses are validated with Zod schemas before use (see src/server_lib/shopifyGetOrdersWithLineItems.ts).
- Use `cache`/`unstable_cache` for Shopify data fetches in server_lib (see shopifyGetOrdersWithLineItems.ts, svrLoadShopifyProducts.ts).
- Audit logging is required for Shopify mutations and order processing using `v3_audit_log` (Prisma or raw SQL).

## Workflows & commands
- Dev server: `yarn dev` (Next.js + Turbopack).
- Build runs GraphQL validation first: `yarn build` ⇒ `yarn graphql:validate` ⇒ `next build`.
- GraphQL schema/types: `yarn graphql:codegen` or `yarn codegen` (downloads schema if env vars set).
- Type checks: `yarn type-check` (tsc, no emit).
- Tests: `yarn test` (Jest + ts-jest); env vars for Shopify are mocked in jest.setup.ts.
- Prisma: `yarn prisma:generate`, `yarn prisma:push:preview` / `yarn prisma:push:production`.

## Integration points & env vars
- Shopify Admin GraphQL requires `SHOPIFY_APP_NAME`, `SHOPIFY_ADMIN_API_TOKEN`, `SHOPIFY_API_KEY`, `SHOPIFY_API_SECRET_KEY` (see src/server_lib/shopify.ts).
- DB access uses `DBHOST`, `DBPORT`, `DBUSER`, `DBPASSWORD`, `DBNAME` (see src/server_lib/db.ts).

## Useful entry points
- Order processing pipeline: src/server_lib/shopifyProcessOrder.ts
- Shopify webhook handler: src/app/api/shopify/webhook/route.ts
- Offer CRUD + manifest APIs: src/app/api/manifest/route.ts
- Shopify data fetch + cache: src/server_lib/shopifyGetProductData.ts
